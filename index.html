<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <link rel="manifest" href="manifest.json">
    <title>OBSIDIAN // ACCESS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            --bg-color: #050505;
            --primary-color: #00ffea;
            --secondary-color: #003b36;
            --accent-color: #00ff00;
            --alert-color: #ff003c;
            --font-main: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--primary-color);
            font-family: var(--font-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* Scanlines */
        body::before {
            content: " ";
            display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        .container {
            width: 90%; max-width: 400px;
            border: 1px solid var(--primary-color);
            padding: 2rem; position: relative; z-index: 3;
            box-shadow: 0 0 15px var(--secondary-color);
            background: rgba(5, 5, 5, 0.95);
        }

        h1 {
            font-size: 1.4rem; text-align: center; margin-bottom: 1.5rem;
            letter-spacing: 2px; border-bottom: 1px solid var(--primary-color);
            padding-bottom: 10px; text-transform: uppercase;
        }

        .input-group { margin-bottom: 1.2rem; }
        
        label { display: block; margin-bottom: 0.5rem; font-size: 0.8rem; opacity: 0.8; }
        
        input {
            width: 100%; background: transparent; border: none;
            border-bottom: 1px solid var(--primary-color);
            color: #fff; font-family: var(--font-main); font-size: 1.1rem;
            padding: 10px 0; outline: none; border-radius: 0;
        }
        input:focus { border-bottom: 1px solid #fff; box-shadow: 0 5px 10px -5px var(--primary-color); }

        .btn-main {
            width: 100%; background: transparent;
            border: 1px solid var(--primary-color); color: var(--primary-color);
            font-family: var(--font-main); font-size: 1.1rem; padding: 15px;
            cursor: pointer; text-transform: uppercase; transition: all 0.2s;
            margin-top: 0.5rem;
        }
        .btn-main:hover { background: var(--primary-color); color: #000; box-shadow: 0 0 15px var(--primary-color); }
        .btn-main:disabled { border-color: #333; color: #333; cursor: not-allowed; box-shadow: none; }

        .auth-actions {
            margin-top: 1.5rem; display: flex; justify-content: space-between;
            font-size: 0.75rem; color: #666;
        }
        .text-btn {
            background: none; border: none; color: #888; 
            font-family: inherit; cursor: pointer; text-decoration: underline;
            padding: 5px; text-transform: uppercase;
        }
        .text-btn:hover { color: var(--primary-color); }

        /* Quick Unlock */
        .user-badge {
            text-align: center; margin-bottom: 20px;
            border: 1px dashed var(--secondary-color); padding: 10px;
        }
        .user-badge strong { display: block; font-size: 1.1rem; color: var(--accent-color); margin-top: 5px; }

        /* KEY GEN STYLES (New) */
        .keygen-box {
            border: 1px solid var(--alert-color);
            padding: 15px; background: rgba(255, 0, 60, 0.05);
            text-align: center; margin-bottom: 20px;
        }
        .generated-key {
            font-size: 1.2rem; color: var(--alert-color);
            word-break: break-all; padding: 15px;
            border: 1px dashed var(--alert-color);
            margin: 15px 0; user-select: text;
            background: #000;
        }
        .warning-text { color: var(--alert-color); font-size: 0.8rem; line-height: 1.4; margin-bottom: 15px; }

        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }

        .status-message {
            margin-top: 1rem; font-size: 0.8rem; min-height: 1.2rem;
            text-align: center; word-break: break-word;
        }
        .error { color: var(--alert-color); }
        .success { color: var(--accent-color); }
    </style>
</head>
<body>

    <div class="container">
        <div id="view-login" class="view-section">
            <h1>IDENTITY REQUIRED</h1>
            <form onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label>USER ID (EMAIL):</label>
                    <input type="email" id="login-email" required placeholder="usr@obsidian.net">
                </div>
                <div class="input-group">
                    <label>ACCOUNT PASSWORD:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn-main" id="btnLogin">AUTHENTICATE</button>
            </form>
            <div class="auth-actions">
                <button class="text-btn" onclick="switchView('signup')">CREATE ID</button>
                <button class="text-btn" onclick="switchView('reset')">LOST PASSWORD?</button>
            </div>
        </div>

        <div id="view-quick" class="view-section">
            <h1>SESSION RESUME</h1>
            <div class="user-badge">
                <span>IDENTITY:</span>
                <strong id="quick-email-display">...</strong>
            </div>
            <form onsubmit="handleQuickUnlock(event)">
                <div class="input-group">
                    <label>ACCOUNT PASSWORD:</label>
                    <input type="password" id="quick-password" required autofocus>
                </div>
                <button type="submit" class="btn-main" id="btnQuick">LOG IN</button>
            </form>
            <div class="auth-actions" style="justify-content: center;">
                <button class="text-btn" onclick="clearSavedUser()">SWITCH IDENTITY</button>
            </div>
        </div>

        <div id="view-signup" class="view-section">
            <h1>NEW IDENTITY</h1>
            <form onsubmit="handleSignup(event)">
                <div class="input-group">
                    <label>ASSIGN EMAIL:</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="input-group">
                    <label>SET PASSWORD:</label>
                    <input type="password" id="signup-password" required minlength="6">
                </div>
                <button type="submit" class="btn-main" id="btnSignup">INITIALIZE ID</button>
            </form>
            <div class="auth-actions" style="justify-content: center;">
                <button class="text-btn" onclick="switchView('login')"><< RETURN</button>
            </div>
        </div>

        <div id="view-keygen" class="view-section">
            <h1 style="color:var(--alert-color); border-color:var(--alert-color);">CRITICAL ACTION</h1>
            <div class="keygen-box">
                <div class="warning-text">
                    ⚠ SECURITY ALERT ⚠<br>
                    THE FOLLOWING KEY IS THE <strong>ONLY WAY</strong> TO DECRYPT YOUR DATA.<br><br>
                    WE CANNOT RECOVER THIS FOR YOU.<br>
                    IF YOU LOSE IT, YOUR DATA IS GONE FOREVER.
                </div>
                <div class="generated-key" id="masterKeyDisplay" onclick="copyKey()">Generating...</div>
                <button class="btn-main" id="btnConfirmKey" onclick="confirmKeySaved()" style="border-color:var(--alert-color); color:var(--alert-color);">I HAVE COPIED THE KEY</button>
            </div>
        </div>

        <div id="view-reset" class="view-section">
            <h1>KEY RECOVERY</h1>
            <form onsubmit="handleReset(event)">
                <div class="input-group">
                    <label>TARGET EMAIL:</label>
                    <input type="email" id="reset-email" required>
                </div>
                <button type="submit" class="btn-main" id="btnReset">SEND SIGNAL</button>
            </form>
            <div class="auth-actions" style="justify-content: center;">
                <button class="text-btn" onclick="switchView('login')"><< RETURN</button>
            </div>
        </div>

        <div class="status-message" id="statusMsg"></div>
    </div>

    <script>
        const statusMsg = document.getElementById('statusMsg');
        
        // CHECK SESSION
        const savedEmail = localStorage.getItem('obsidian_user_email');
        if (savedEmail) {
            document.getElementById('quick-email-display').innerText = savedEmail;
            switchView('quick');
        } else {
            switchView('login');
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            statusMsg.innerText = '';
        }

        // --- AUTH LOGIC ---

        async function handleLogin(e) {
            e.preventDefault();
            setLoading('btnLogin', true);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showError(error.message);
                setLoading('btnLogin', false);
            } else {
                localStorage.setItem('obsidian_user_email', email);
                window.location.href = 'dashboard.html';
            }
        }

        async function handleQuickUnlock(e) {
            e.preventDefault();
            setLoading('btnQuick', true);
            const email = localStorage.getItem('obsidian_user_email');
            const password = document.getElementById('quick-password').value;

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showError("INVALID CREDENTIALS");
                setLoading('btnQuick', false);
            } else {
                window.location.href = 'dashboard.html';
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            setLoading('btnSignup', true);
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            const { data, error } = await supabase.auth.signUp({ email, password });

            if (error) {
                showError(error.message);
                setLoading('btnSignup', false);
            } else {
                // SUCCESS: DO NOT REDIRECT YET
                // INSTEAD, SHOW THE MASTER KEY
                if (data.session) {
                    localStorage.setItem('obsidian_user_email', email);
                    generateAndShowKey();
                } else {
                    // Email confirm required (if enabled)
                    showSuccess("CHECK EMAIL TO CONFIRM ID.");
                }
            }
        }

        // --- KEY GENERATION LOGIC ---
        function generateAndShowKey() {
            // 1. Generate a strong random UUID
            const key = crypto.randomUUID().toUpperCase();
            
            // 2. Display it
            document.getElementById('masterKeyDisplay').innerText = key;
            
            // 3. Switch View
            switchView('keygen');
        }

        function copyKey() {
            const key = document.getElementById('masterKeyDisplay').innerText;
            navigator.clipboard.writeText(key).then(() => {
                showSuccess("COPIED TO CLIPBOARD");
            });
        }

        function confirmKeySaved() {
            // User confirms they saved it. Now we let them in.
            window.location.href = 'dashboard.html';
        }

        // --- UTILS ---
        async function handleReset(e) {
            e.preventDefault();
            setLoading('btnReset', true);
            const email = document.getElementById('reset-email').value;
            const { error } = await supabase.auth.resetPasswordForEmail(email);
            if (error) showError(error.message);
            else showSuccess("RESET LINK SENT.");
            setLoading('btnReset', false);
        }

        function clearSavedUser() {
            localStorage.removeItem('obsidian_user_email');
            switchView('login');
        }

        function setLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if(isLoading) { btn.disabled = true; btn.innerText = "PROCESSING..."; }
            else { btn.disabled = false; btn.innerText = "SUBMIT"; }
        }

        function showError(msg) { statusMsg.innerText = ">> ERROR: " + msg.toUpperCase(); statusMsg.className = "status-message error"; }
        function showSuccess(msg) { statusMsg.innerText = ">> " + msg; statusMsg.className = "status-message success"; }
    </script>
</body>
</html>
